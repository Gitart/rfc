# Morion GEO Services API (Draft)

*This document is a work in progress. The API is not stable.*

## Соглашения

1. Протокол передачи данных [HTTP](http://ru.wikipedia.org/wiki/HTTP).

2. Формат приема-передачи данных [JSON](http://json.org/).

3. Коды состояния [стандартные](http://en.wikipedia.org/wiki/List_of_HTTP_status_codes) и возвращаются всегда. Клиент имеет право на их интерпретацию. Ошибки могут быть дополнительно подробно описаны в теле ответа запроса.

## Аутентификация

FIXME

## Интерфейс

API реализуется двумя методами HTTP: 

* `GET` - для получения данных из сервиса в теле ответа на запрос 
* `POST` - для передачи данных в сервис в теле запроса.

----

### Пользователь
Пользователь задается для возможности входа по имени и паролю. Также с пользователем ассоциируется сеть точек продаж. Принято, что эта связь типа `один-к-одному`.
#### Структура данных и методы

```json
{
  "id": "",   // Уникальный идентификатор
  "name": "", // Имя пользователя (логин)
  "pass": "", // Хеш SHA1 строкового пароля пользователя
  "desc": ""  // Описание пользователя (для понимания)
}
```

```
/user/new              // Создать нового пользователя
/user/:id/get          // Получить пользователя по его идентификатору
/user/:name/:pass/get  // Получить пользователя по его имени и паролю
/user/:id/set          // Обновить данные конкретного пользователя
/user/:id/del          // Удалить конкретного пользователя
/user/:id/heads        // Получить список сетей (юрлиц), ассоциируемых с искомым пользователем
```

#### `POST /user/new`
Запрос создает новую "запись" на основе переданной в его теле заполненной стуктуры данных.

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле простой строкой уникальный идентификатор, например `525e60029678f761d8000001`. 

* Неудачный ответ: в заголовке код ошибки `415` (StatusUnsupportedMediaType) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /user/:id/get`
Запрос возвращает известную "запись". Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `200` (StatusOK), в теле заполненная структура данных. 

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /user/:name/:pass/get`
Запрос возвращает известную "запись". Вместо `:name` подставить имя пользователя (логин), а вместо `:pass` значение SHA1 от строкового пароля пользователя. 

* Успешный ответ: в заголовке `200` (StatusOK), в теле заполненная структура данных. 

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `POST /user/:id/set`
Запрос обновляет известную "запись" на основе переданной в его теле заполненной стуктуры данных (полностью или ее части). Вместо `:id` подставить уникальный идентификатор. 

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле пусто.

* Неудачный ответ: в заголовке код ошибки `415` (StatusUnsupportedMediaType) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `POST /user/:id/del`
Запрос удаляет известную "запись" на основе ее уникального идентификатора. Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле пусто.

* Неудачный ответ: в заголовке код ошибки `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /user/:id/heads`
Запрос возвращает список сетей (юрлиц), ассоциированных с конкретной "записью". Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `200` (StatusOK), в теле массив из искомых структур данных [{},...].

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

----

### Сеть (юрлицо)
Сеть соответствует одному пользователю и содержит не менее одной точки продажи.
#### Структура данных и методы

```json
{
  "id": "",             // Уникальный идентификатор
  "id_user": "",        // Указатель на пользователя
  "name": "",           // Название (торговое)
  "name_full": "",      // Название полное
  "name_short": "",     // Название краткое
  "egrpou": "",         // ЕГРПОУ (ОКПО)
  "description": "",    // Описание торговой сети
  "addr1_country": "",  // Адрес(Ю).Страна
  "addr1_area": "",     // Адрес(Ю).Область
  "addr1_region": "",   // Адрес(Ю).Район
  "addr1_city": "",     // Адрес(Ю).Населенный пункт
  "addr1_post": "",     // Адрес(Ю).Почтовый индекс
  "addr1_street": "",   // Адрес(Ю).Улица, дом
  "addr2_country": "",  // Адрес(Ф).Страна
  "addr2_area": "",     // Адрес(Ф).Область
  "addr2_region": "",   // Адрес(Ф).Район
  "addr2_city": "",     // Адрес(Ф).Населенный пункт
  "addr2_post": "",     // Адрес(Ф).Почтовый индекс
  "addr2_street": "",   // Адрес(Ф).Улица, дом
  "cont_name": "",      // Контакт.Контактное лицо (ФИО)
  "cont_mail": "",      // Контакт.Почта(ы)
  "cont_site": "",      // Контакт.Сайт(ы)
  "cont_phone": "",     // Контакт.Телефон(ы)
  "cont_skype": "",     // Контакт.Skype(ы)
  "cont_chief": "",     // Контакт.Директор (ФИО)
  "lcns_name": "",      // Лицензия.Название (Номер)
  "lcns_date1": "",     // Лицензия.Дата 1 (Начало)
  "lcns_date2": "",     // Лицензия.Дата 2 (Окончание)
  "no_acc": "",         // Номер расчетного счета
  "no_mfo": "",         // Номер МФО
  "no_inn": "",         // Номер индивидуальный налоговый (ИНН)
  "no_reg": "",         // Номер свидетельства регистрации
  "no_vat": "",         // Номер свидетельства плательщика НДС
  "ax_sign": false      // Знак Аксиомы (true - заверено)
}

```

```
/head/new        // Создать новую сеть (юрлицо)
/head/:id/get    // Получить сеть по ее идентификатору
/head/:id/set    // Обновить данные конкретной сети
/head/:id/del    // Удалить конкретную сеть
/head/:id/shops  // Получить список точек продаж, ассоциируемых с искомой сетью
```

#### `POST /head/new`
Запрос создает новую "запись" на основе переданной в его теле заполненной стуктуры данных.

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле простой строкой уникальный идентификатор, например `525e60029678f761d8000001`. 

* Неудачный ответ: в заголовке код ошибки `415` (StatusUnsupportedMediaType) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /head/:id/get`
Запрос возвращает известную "запись". Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `200` (StatusOK), в теле заполненная структура данных. 

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `POST /head/:id/set`
Запрос обновляет известную "запись" на основе переданной в его теле заполненной стуктуры данных (полностью или ее части). Вместо `:id` подставить уникальный идентификатор. 

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле пусто.

* Неудачный ответ: в заголовке код ошибки `415` (StatusUnsupportedMediaType) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `POST /head/:id/del`
Запрос удаляет известную "запись" на основе ее уникального идентификатора. Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле пусто.

* Неудачный ответ: в заголовке код ошибки `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /head/:id/shops`
Запрос возвращает список точек продаж, ассоциированных с конкретной "записью". Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `200` (StatusOK), в теле массив из искомых структур данных [{},...].

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

----

### Точка (продажи)
#### Структура данных и методы
```json
{
  "id": "",              // Уникальный идентификатор
  "id_head": "",         // Указатель на голову (юр лицо)
  "name": "",            // Название (торговое)
  "kind": "",            // Тип (Аптека|Аптечный пункт)
  "addr_country": "",    // Адрес.Страна
  "addr_area": "",       // Адрес.Область
  "addr_region": "",     // Адрес.Район
  "addr_city": "",       // Адрес.Населенный пункт
  "addr_post": "",       // Адрес.Почтовый индекс
  "addr_street": "",     // Адрес.Улица, дом
  "cont_name": "",       // Контакт.Контактное лицо (ФИО)
  "cont_mail": "",       // Контакт.Почта(ы)
  "cont_site": "",       // Контакт.Сайт(ы)
  "cont_phone": "",      // Контакт.Телефон(ы)
  "cont_skype": "",      // Контакт.Skype(ы)
  "cont_chief": "",      // Контакт.Директор (ФИО)
  "desc_mode": "",       // Описание.Режим работы торговой точки
  "desc_path": "",       // Описание.Как проехать
  "desc_delv": "",       // Описание.Доставка|Самовывоз
  "desc_delv_note": "",  // Описание.Условия доставки/самовывоза
  "desc_book": "",       // Описание.Бронирование|Заказ
  "desc_book_note": "",  // Описание.Условия бронипрования/заказа
  "desc_disc": "",       // Описание.Дисконтная программа
  "geo_lat": 0,          // Координата.Широта
  "geo_lng": 0,          // Координата.Долгота
  "ax_sign": false       // Знак Аксиомы (true - заверено)
}

```

```
/shop/new        // Создать новую точку продажи
/shop/:id/get    // Получить точку по ее идентификатору
/shop/:id/set    // Обновить данные конкретной точки
/shop/:id/del    // Удалить конкретную точку
```

#### `POST /shop/new`
Запрос создает новую "запись" на основе переданной в его теле заполненной стуктуры данных.

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле простой строкой уникальный идентификатор, например `525e60029678f761d8000001`. 

* Неудачный ответ: в заголовке код ошибки `415` (StatusUnsupportedMediaType) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /shop/:id/get`
Запрос возвращает известную "запись". Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `200` (StatusOK), в теле заполненная структура данных. 

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `POST /shop/:id/set`
Запрос обновляет известную "запись" на основе переданной в его теле заполненной стуктуры данных (полностью или ее части). Вместо `:id` подставить уникальный идентификатор. 

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле пусто.

* Неудачный ответ: в заголовке код ошибки `415` (StatusUnsupportedMediaType) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `POST /shop/:id/del`
Запрос удаляет известную "запись" на основе ее уникального идентификатора. Вместо `:id` подставить уникальный идентификатор.

* Успешный ответ: в заголовке `202` (StatusAccepted), в теле пусто.

* Неудачный ответ: в заголовке код ошибки `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

----

### Аксиома ###
#### Методы ####
#### `GET  /axioma/heads`
Запрос возвращает список сетей (юрлиц) на проверку в Аксиому.

* Успешный ответ: в заголовке `200` (StatusOK), в теле массив из искомых структур данных [{},...].

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.


#### `GET  /axioma/shops`
Запрос возвращает список точек продаж на проверку в Аксиому.

* Успешный ответ: в заголовке `200` (StatusOK), в теле массив из искомых структур данных [{},...].

* Неудачный ответ: в заголовке код ошибки `404` (StatusNotFound) либо `500` (StatusInternalServerError), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

----

### Разное ###
#### Методы ####

#### `GET  /mongo/ping`
Запрос возвращает первый признак жизни хранилища данных.

* Успешный ответ: в заголовке `200` (StatusOK), в теле строка `PONG`

* Неудачный ответ: в заголовке код ошибки `503` (StatusServiceUnavailable), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.

#### `GET  /mongo/info`
Запрос возвращает некоторую информацию от хранилища данных.

* Успешный ответ: в заголовке `200` (StatusOK), в теле as-is json с параметрами хранилища.

* Неудачный ответ: в заголовке код ошибки `503` (StatusServiceUnavailable), в теле простой строкой возможно более подробное сообщение о возникшей ошибке.


<!--
### `/name/get` - названия брендов (что?)

Получение списка названий брендов по введенным начальным символам (более двух). 

```
GET http://example.com/name/get?sstr=value&keysum=value1,value2 HTTP/1.1
```

Результат отсортирован по названию в алфавитном порядке. Каждый бренд содержит список его лекарственных форм, которые получаются отдельным запросом (см. ниже)

```json
[
	{
		"Code": "f96b5d372f91a519cbc7676906aeb99fb6b2bc37", // Уникальный иденификатор
		"Name": "АНАЛЬГИН"                                  // Название бренда (товара)
	},
	{
		"Code": "cbc7676906aeb99f96b5d372f91a519fb6b2bc37",
		"Name": "АНАЛЬГИН ДЛЯ ДЕТЕЙ"
	},
	{
		"Code": "9f96b5d372f91cbc7676906aeb9a519fb6b2bc37",
		"Name": "АНАЛЬГИН-ДАРНИЦА"
	},
	...
]
```

### `/drug/get` - лекформы (что конкретно?)


Получение списка названий лекарственных форм (товара) по коду бренда или по поисковой строке. 

```
GET http://example.com/drug/get?code_or_sstr=value&keysum=value1,value2 HTTP/1.1
```

Результат отсортирован по названию + форме выпуска +  значению количества действующего вещества + номеру в упаковке + производителю. Каждая лекарственная форма может продаваться в нескольких аптеках, список которых получается отдельным запросом (см. ниже)

```json
[
	{
		"Code": "9a59f96b5d372f91cbc7676906aeb19fb6b2bc37",                            // Уникальный иденификатор
		"Name": "АНАЛЬГИН р-р д/ин. 25% амп. 1 мл №10 / Биолек ЗАО (Украина, Харьков)" // Название лекарственной формы (товара)
	},
	{
		"Code": "b906ae199a59f96b5d372f91cbc7676fb6b2bc37",
		"Name": "АНАЛЬГИН табл. 0,5 г блистер №6 / Красная Звезда ОАО (Украина, Харьков)"
	},
	{
		"Code": "7691cbc76fb6b2bc37906aeb199a59f96b5d372f",
		"Name": "АНАЛЬГИН табл. 0,5 г стрип №10 / Лубныфарм ОАО (Украина, Лубны)"
	},
	...
]
```

### `/shop/get` - аптеки (где?)

Получение списка аптек по коду лекарственной формы. 

```
GET http://example.com/shop/get?code=value&latlng=value1,value2&keysum=value1,value2 HTTP/1.1
```

Результат ограничен по количеству в зависимости от известности местоположения пользователя:

1. неизвестно (все? вопрос...)

2. город (все в городе)

3. точные координаты (7 рядом)

Расширенная информация по аптеке может быть получена отдельным запросом (см. ниже)

```json
[
	{
		"Code": "5d372f91cb9a59f96bc7676906aeb19fb6b2bc37", // Уникальный иденификатор
		"Latitude": 80.4567,                                // Координата Широта
		"Longitude": 67.999432,                             // Координата Долгота
		"Level": 4,                                         // Рейтинг сервисов аптеки
		"ETime": 24,                                        // Время (примерное) в пути до аптеки от точки пользователя
		"Price": 4.50                                       // Цена
	},
	{
		"Code": "cbc5d372f917906aeb199a59f96b676fb6b2bc37",
		"Latitude": 50.451267,
		"Longitude": 30.499932,
		"Level": 5,
		"ETime": 25,
		"Price": 18.55
	},
	{
		"Code": "06aeb199a59f96b5d91cbc7676fb6b2bc379372f",
		"Latitude": 57.465127,
		"Longitude": 28.932499,
		"Level": 4,
		"ETime": 54,
		"Price": 104.00
	},
	...
]
```

### `/orgs/get` `/orgs/set` `/orgs/del`

Получение расширенной информации об искомой аптеке по ее коду.

```
GET http://example.com/orgs/get?code=value&keysum=value1,value2 HTTP/1.1
```

Результат все доступные данные по аптеке или сети.


```json
{
	"Code": "7676906aeb99fb6b2bc37f96b5d372f91a519cbc",    // Код торговой точки
	"CodeNet": "f96b5d372f91a519cbc7676906aeb99fb6b2bc37", // Код торговой сети
	"Name": "Аптека 8",                                    // Название торговой точки
	"Kind": "Аптека",                                      // Тип торговой точки (Аптека|Аптечный пункт)
	"AddrCountry": "Украина",                              // Страна
	"AddrRegion": "Киевская",                              // Область
	"AddrArea": "Киевский",                                // Район
	"AddrCity": "Киев",                                    // Населенный пункт
	"AddrPost": "01054",                                   // Почтовый индекс
	"AddrStreet": "ул.Воровского, 27",                     // Улица, дом
	"ContactName": "Сидоров Петр Иванович",                // Контактное лицо
	"ContactMail": "mail@example.com",                     // Контактная почта
	"ContactPhone": "(044)4515602",                        // Контактный телефон
	"Latitude": 50.451267,                                 // Координата Широта
	"Longitude": 30.499932,                                // Координата Долгота
	"Phone": "(044)4515602",                               // Телефон(ы)
	"Skype": "apteka-example",                             // Skype ^
	"DescMode": "Пн-С: с 8-00 до 21-00\nВс: выходной",     // Описание режима работы торговой точки FIXME
	"DescPath": "От \"Цирка\" марш. №439 две ост.",        // Описание проезда ^
	"DescDisc": "Скидки владельцам дисконтных карт.",      // Описание дисконтной программы ^
	"TypeDeliver": "самомывоз",                            // Доставка/самовывоз ^
	"TypeBooking": "бронирование",                         // Бронирование/заказ ^
	"DescDelivery": "самомывоз",                           // Описание условий доставки/самовывоза ^
	"DescBooking": "бронирование в течение 2 суток",       // Описание условий бронипрования/заказа ^
	"Active": true                                         // Признак активности аккаунта по Аксиоме
}

```
Сеть.

```json
{
	"Code": "f96b5d372f91a519cbc7676906aeb99fb6b2bc37",  // Код торговой сети
	"Name": "Аптека Example",                            // Наименование сети (торговая марка)
	"NameFull": "Аптека Example",                        // Полное наименование юридического лица
	"NameShort": "А-Example",                            // Краткое наименование юридического лица
	"Description": "\"АПТЕКА EXAMPLE\" - все по 1 грн!", // Описание аптеки/сети 
	"AddrLegalCountry": "Украина",                       // Юридический адрес: Страна
	"AddrLegalRegion": "Киевская",                       // Юридический адрес: Область
	"AddrLegalArea": "Киевский",                         // Юридический адрес: Район
	"AddrLegalCity": "Киев",                             // Юридический адрес: Населенный пункт
	"AddrLegalPost": "01054",                            // Юридический адрес: Почтовый индекс
	"AddrLegalStreet": "ул.Воровского, 27",              // Юридический адрес: Улица, дом
	"AddrPhysicCountry": "Украина",                      // Физический адрес: Страна
	"AddrPhysicRegion": "Киевская",                      // Физический адрес: Область
	"AddrPhysicArea": "Киевский",                        // Физический адрес: Район
	"AddrPhysicCity": "Киев",                            // Физический адрес: Населенный пункт
	"AddrPhysicPost": "01054",                           // Физический адрес: Почтовый индекс
	"AddrPhysicStreet": "ул.Воровского, 27",             // Физический адрес: Улица, дом
	"ContactName": "Сидоров Петр Иванович",              // Контактное лицо
	"ContactMail": "mail@example.com",                   // Контактная почта
	"ContactPhone": "(044)4515602",                      // Контактный телефон
	"Director": "Иван Петрович Сидоров",                 // Директор (ФИО)
	"SiteCorp": "http://apteka-example.com.ua",          // Сайт корпоративный
	"SiteSale": "http://sale.apteka-example.com.ua",     // Сайт продажный
	"License": "АВ №574839",                             // Лицензия номер
	"LicenseStart": "12.08.2013",                        // Лицензия дата начала
	"LicenseFinish": "12.08.2018",                       // Лицензия дата окончания
	"EGRPOU": "95738475",                                // ЕГРПОУ
	"NoACC": "18293834750984",                           // Расчетный счет ^
	"NoMFO": "389576",                                   // МФО ^
	"NoINN": "123456789098",                             // Индивидуальный налоговый номер (ИНН) ^
	"NoREG": "987465738",                                // Номер свидетельства регистрации ^
	"NoVAT": "847563729",                                // Номер свидетельства плательщика НДС ^
	"Active": true                                       // Признак активности аккаунта по Аксиоме
}
```

Изменение, параметр `code` не указан, то создается новая запись (идентификатор будет возвращен в теле ответа)

```
POST http://example.com/orgs/set?code=value&keysum=value1,value2 HTTP/1.1
```

Удаление

```
POST http://example.com/orgs/del?code=value&keysum=value1,value2 HTTP/1.1
```

### `/data/add`


```json
{
	"Meta": {
		"Code": "96b5d372f91a519cbc7676906aeb99fb6b2bc37f", // Код торговой точки
		"Head": "А-Example",                                // Название сети (юр.лица)
		"Name": "Аптека 8",                                 // Название торговой точки
		"Addr": "Киев, Воровского 27",                      // Адрес торговой точки
		"EGRPOU": "95738475",                               // ЕГРПОУ
		"DateTimeZone": "",                                 // Дата/время/временная зона формирования прайса 				
		"Version": 1,                                       // Версия формата
		"Agent": "My Cool Application"                      // Агент передачи данных (программа) ^
	},
	"Data": [{
		"Code": "321654",                                   // Код товара в торговой точке
		"Name": "ГЕПТРАЛ табл.400мг№20 Аббот Швейцария",    // Полное наименование препарата + производитель (через пробел)
		"Desc": "Скидка 6% с 1.03.13 по 31.03.13",          // Описание (акция)
		"Addr": "http://www.add.ua/shop/UID_84054.html",    // Адрес товара на сайте интернет-аптеки
		"Price": 325.00,                                    // Цена розничная
		"Quant": 2.33                                       // Остаток товара в торговой точке		
	}]
}
```
-->